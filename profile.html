<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>‰∏™‰∫∫ËµÑÊñô - Innonation</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="https://innonation.oss-cn-beijing.aliyuncs.com/shortcut/in.jpg">

    <!-- ÂºïÂÖ•Áé∞‰ª£CSSÊ°ÜÊû∂ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 6 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- AOS Âä®ÁîªÂ∫ì -->
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">

    <!-- ‰ΩøÁî®ÈÄöÁî®Ê†∑Âºè -->
    <link rel="stylesheet" href="common/css/variables.css">
    <link rel="stylesheet" href="common/css/components.css">
	<link rel="stylesheet" href="common/css/inno-global-menu.css">
	<link rel="stylesheet" href="common/css/user-profile.css">

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        /* Profile Page Styles */
:root {
	--primary-blue: #1e40af;
	--secondary-blue: #3b82f6;
	--accent-orange: #f59e0b;
	--success-green: #10b981;
	--warning-yellow: #f59e0b;
	--error-red: #ef4444;
	--dark-gray: #1f2937;
	--light-gray: #f9fafb;
	--border-gray: #e5e7eb;

	/* ‰∏ªËâ≤Ë∞É - ‰ΩøÁî®Áªü‰∏ÄÁöÑCSSÂèòÈáèÂëΩÂêç */
	--color-brand-blue: #196fa6;
	--color-deep-blue: #104991;
	--color-highlight-blue: #0ea5e9;
	--color-action-blue: #196fa6;
	--color-light-blue: #f4f8fb;

	/* ÊñáÂ≠óÈ¢úËâ≤ */
	--text-color: #1e293b;
	--light-text: #64748b;

	/* ËÉåÊôØÈ¢úËâ≤ */
	--background-light: #f8fbfd;
	--background-white: #ffffff;

	/* Âº∫Ë∞ÉÂíåÁä∂ÊÄÅÈ¢úËâ≤ */
	--accent-color: #f39c12;
	--success-color: #27ae60;
	--warning-color: #f59e0b;
	--error-color: #e74c3c;
	--info-color: #8e44ad;

	/* Èò¥ÂΩ±ÊïàÊûú */
	--card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
	--hover-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

	/* ËæπÊ°ÜÂíåÈó¥Ë∑ù */
	--border-color: #e2e8f0;
	--border-radius: 0.5rem;
	--border-radius-lg: 0.75rem;
	--border-radius-xl: 1rem;

	/* ËøáÊ∏°Âä®Áîª */
	--transition-base: 0.2s ease-in-out;
	--transition-slow: 0.3s ease-in-out;
}

body {
	font-family: 'Roboto', 'Noto Sans SC', 'Source Han Sans SC', 'Microsoft YaHei', sans-serif !important;
	color: var(--text-color) !important;
	background: linear-gradient(135deg, var(--background-light) 0%, #ffffff 100%) !important;
	line-height: 1.6;
	overflow-x: hidden;
	margin: 0;
	padding: 0;
	min-height: 100vh;
}

/* ÈöêËóèVueÊú™ÁºñËØëÂÜÖÂÆπ */
[v-cloak] {
	display: none;
}

/* ÂØºËà™Ê†èÊ†∑Âºè */
.navbar {
	background: rgba(255, 255, 255, 0.95);
	backdrop-filter: blur(10px);
	border-bottom: 1px solid rgba(25, 111, 166, 0.1);
	padding: 1rem 0;
	margin-bottom: 2rem;
	box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
}

.navbar-brand {
	font-size: 1.5rem;
	font-weight: 700;
	color: var(--color-brand-blue) !important;
	text-decoration: none;
}

.navbar-brand b {
	color: var(--color-deep-blue);
}

/* È°µÈù¢ÂÆπÂô® */
.page-container {
	padding-bottom: 2rem;
}

/* Âç°ÁâáÊ†∑Âºè */
.card {
	background-color: var(--background-white);
	border-radius: var(--border-radius-lg);
	border: 1px solid rgba(0, 0, 0, 0.08);
	box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
	transition: all var(--transition-base);
	position: relative;
	overflow: visible;
	margin-bottom: 1.5rem;
}

.card::before {
	content: '';
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	height: 3px;
	background: linear-gradient(90deg, var(--color-brand-blue), var(--color-deep-blue));
	opacity: 0;
	transition: opacity var(--transition-base);
}

.card:hover {
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
	transform: translateY(-1px);
	border-color: rgba(25, 111, 166, 0.15);
}

.card:hover::before {
	opacity: 1;
}

.card-header {
	padding: 1.5rem;
	border-bottom: 1px solid rgba(0, 0, 0, 0.06);
	background: rgba(248, 250, 252, 0.5);
}

.card-header h5 {
	margin: 0;
	color: var(--text-color);
	font-weight: 600;
	display: flex;
	align-items: center;
	gap: 0.5rem;
}

.card-header h5 i {
	color: var(--color-brand-blue);
}

.card-body {
	padding: 2rem;
}

/* Áî®Êà∑Â§¥ÂÉè - Âç°ÁâáÂÜÖÂ∞èÂ∞∫ÂØ∏ */
.profile-avatar-container {
	position: absolute;
	top: 1.5rem;
	right: 1.5rem;
	z-index: 10;
}

.profile-avatar {
	width: 80px;
	height: 80px;
	border-radius: 50%;
	border: 3px solid white;
	box-shadow: 0 2px 10px rgba(25, 111, 166, 0.2);
	object-fit: cover;
	display: block;
}

.profile-avatar-placeholder {
	width: 80px;
	height: 80px;
	border-radius: 50%;
	border: 3px solid white;
	box-shadow: 0 2px 10px rgba(25, 111, 166, 0.2);
	display: flex;
	align-items: center;
	justify-content: center;
	background: linear-gradient(135deg, var(--color-brand-blue), var(--color-deep-blue));
	color: white;
	font-size: 2rem;
}

.profile-user-info {
	margin-bottom: 1.5rem;
	padding-right: 100px; /* ‰∏∫Â§¥ÂÉèÁïôÂá∫Á©∫Èó¥ */
}

.profile-user-name {
	font-size: 1.5rem;
	font-weight: 600;
	color: var(--text-color);
	margin-bottom: 0.25rem;
}

.profile-user-email {
	font-size: 0.95rem;
	color: var(--light-text);
}

/* Ë°®ÂçïÊ†∑Âºè */
.form-group {
	margin-bottom: 1.5rem;
}

.form-label {
	font-weight: 500;
	color: var(--text-color);
	margin-bottom: 0.5rem;
	display: block;
}

.form-label .required {
	color: var(--error-color);
	margin-left: 0.25rem;
}

.form-control {
	border: 2px solid var(--border-color);
	border-radius: var(--border-radius);
	padding: 0.75rem 1rem;
	font-size: 1rem;
	transition: all var(--transition-base);
	width: 100%;
}

.form-control:focus {
	border-color: var(--color-brand-blue);
	box-shadow: 0 0 0 0.2rem rgba(25, 111, 166, 0.15);
	outline: none;
}

.form-control:disabled {
	background-color: var(--light-gray);
	cursor: not-allowed;
}

/* ÂØÜÁ†ÅËæìÂÖ•Ê°ÜÂÆπÂô® */
.password-input-container {
	position: relative;
	display: flex;
	align-items: center;
}

.password-input-container .form-control {
	padding-right: 3rem;
}

.password-toggle {
	position: absolute;
	right: 0.75rem;
	top: 50%;
	transform: translateY(-50%);
	background: none;
	border: none;
	color: var(--light-text);
	cursor: pointer;
	padding: 0.5rem;
	font-size: 1.1rem;
	transition: color var(--transition-base);
	z-index: 10;
}

.password-toggle:hover {
	color: var(--color-brand-blue);
}

.password-toggle:focus {
	outline: none;
}

.form-text {
	font-size: 0.875rem;
	color: var(--light-text);
	margin-top: 0.5rem;
	display: block;
}

/* ÊåâÈíÆÊ†∑Âºè */
.btn {
	padding: 0.75rem 2rem;
	border-radius: var(--border-radius);
	font-weight: 500;
	font-size: 1rem;
	transition: all var(--transition-base);
	border: none;
	cursor: pointer;
	display: inline-flex;
	align-items: center;
	gap: 0.5rem;
	text-decoration: none;
}

.btn-primary {
	background: linear-gradient(135deg, var(--color-brand-blue), var(--color-deep-blue));
	color: white;
}

.btn-primary:hover {
	transform: translateY(-2px);
	box-shadow: 0 6px 20px rgba(25, 111, 166, 0.3);
}

.btn-primary:disabled {
	opacity: 0.6;
	cursor: not-allowed;
	transform: none;
}

.btn-secondary {
	background: var(--light-gray);
	color: var(--text-color);
}

.btn-secondary:hover {
	background: var(--border-color);
}

/* Ê†áÁ≠æÈ°µÊ†∑Âºè */
.nav-tabs {
	border-bottom: 2px solid var(--border-color);
	margin-bottom: 1.5rem;
}

.nav-tabs .nav-link {
	border: none;
	border-bottom: 3px solid transparent;
	color: var(--light-text);
	font-weight: 500;
	padding: 1rem 1.5rem;
	transition: all var(--transition-base);
}

.nav-tabs .nav-link:hover {
	color: var(--color-brand-blue);
	border-bottom-color: var(--color-brand-blue);
}

.nav-tabs .nav-link.active {
	color: var(--color-brand-blue);
	border-bottom-color: var(--color-brand-blue);
	background: none;
}

/* È™åËØÅÊèêÁ§∫ */
.validation-error {
	color: var(--error-color);
	font-size: 0.875rem;
	margin-top: 0.5rem;
	display: none;
}

.validation-error.show {
	display: block;
}

/* Ë°®Ê†ºÊ†∑Âºè */
.table {
	width: 100%;
	margin-bottom: 0;
}

.table thead th {
	background: var(--light-gray);
	color: var(--text-color);
	font-weight: 600;
	border: none;
	padding: 1rem;
}

.table tbody td {
	padding: 1rem;
	border-top: 1px solid var(--border-color);
	vertical-align: middle;
}

.table tbody tr:hover {
	background: rgba(25, 111, 166, 0.05);
}

/* Âä†ËΩΩÁä∂ÊÄÅ */
.loading-overlay {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background: rgba(255, 255, 255, 0.9);
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 9999;
}

.spinner-border {
	width: 3rem;
	height: 3rem;
	border: 0.25rem solid var(--color-brand-blue);
	border-right-color: transparent;
	border-radius: 50%;
	animation: spinner-border 0.75s linear infinite;
}

@keyframes spinner-border {
	to { transform: rotate(360deg); }
}

/* Ê∂àÊÅØÊèêÁ§∫ */
.alert {
	padding: 1rem 1.5rem;
	border-radius: var(--border-radius);
	margin-bottom: 1.5rem;
	display: flex;
	align-items: center;
	gap: 0.75rem;
}

.alert-success {
	background: rgba(16, 185, 129, 0.1);
	border: 1px solid var(--success-green);
	color: var(--success-green);
}

.alert-danger {
	background: rgba(239, 68, 68, 0.1);
	border: 1px solid var(--error-red);
	color: var(--error-red);
}

.alert-info {
	background: rgba(25, 111, 166, 0.1);
	border: 1px solid var(--color-brand-blue);
	color: var(--color-brand-blue);
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
	.page-container {
		padding-top: 80px;
	}

	.card-body {
		padding: 1.5rem;
	}

	.btn {
		width: 100%;
		justify-content: center;
	}

	.nav-tabs .nav-link {
		padding: 0.75rem 1rem;
		font-size: 0.9rem;
	}

	.profile-avatar-container {
		position: static;
		text-align: center;
		margin-bottom: 1rem;
	}

	.profile-user-info {
		padding-right: 0;
		text-align: center;
	}

	.card-header {
		text-align: center;
		padding-bottom: 1rem;
	}

	.card-header h5 {
		justify-content: center;
		margin-bottom: 1rem;
	}
}
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <!-- ÂÖ®Â±ÄËèúÂçïÊåÇËΩΩÁÇπ -->
        <div id="inno-global-menu"></div>

        <!-- ÂØºËà™Ê†è -->
        <nav class="navbar navbar-expand-lg fixed-top">
            <div class="container">
                <a class="navbar-brand" href="#">
                    INNONATION <b>AI</b>
                </a>
                <div class="ms-auto d-flex align-items-center gap-3">
                    <div class="language-switch" @click="toggleLang">
                        <i class="fa-solid fa-globe"></i>
                        <span class="lang-text">{{ currentLang === 'zh' ? 'EN' : '‰∏≠Êñá' }}</span>
                    </div>
                    <!-- Áî®Êà∑ProfileÊåÇËΩΩÁÇπ -->
                    <div id="user-profile-mount"></div>
                </div>
            </div>
        </nav>

        <!-- Loading State -->
        <div v-if="loading" class="loading-overlay">
            <div class="text-center">
                <div class="spinner-border"></div>
                <p class="mt-3">{{ t('loading') }}</p>
            </div>
        </div>

        <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
        <div class="container page-container">
            <!-- Ê†áÁ≠æÈ°µÂØºËà™ -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
                        <i class="fas fa-user-edit"></i> {{ t('editProfile') }}
                    </button>
                </li>
                <li class="nav-item" role="presentation" v-if="showPasswordTab">
                    <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab">
                        <i class="fas fa-key"></i> {{ t('changePassword') }}
                    </button>
                </li>
                <li class="nav-item" role="presentation" v-if="showExportTab">
                    <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button" role="tab">
                        <i class="fas fa-download"></i> {{ t('dataExportHistory') }}
                    </button>
                </li>
            </ul>

            <!-- Ê†áÁ≠æÈ°µÂÜÖÂÆπ -->
            <div class="tab-content">
                <!-- ÁºñËæëËµÑÊñô -->
                <div class="tab-pane fade show active" id="profile" role="tabpanel">
                    <div class="card" data-aos="fade-up">
                        <div class="card-header">
                            <h5><i class="fas fa-user-circle"></i> {{ t('personalInformation') }}</h5>
                            <!-- Áî®Êà∑Â§¥ÂÉè - Âè≥‰∏äËßí -->
                            <div class="profile-avatar-container">
                                <img v-if="userProfile.avatar" :src="userProfile.avatar" alt="User Avatar" class="profile-avatar">
                                <div v-else class="profile-avatar-placeholder">
                                    <i class="fas fa-user"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Áî®Êà∑‰ø°ÊÅØ -->
                            <div class="profile-user-info">
                                <div class="profile-user-name">{{ userProfile.firstName }} {{ userProfile.lastName }}</div>
                                <div class="profile-user-email">{{ userProfile.email }}</div>
                            </div>
                            <div v-if="message.text" :class="'alert alert-' + message.type">
                                <i :class="message.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'"></i>
                                {{ message.text }}
                            </div>

                            <form @submit.prevent="updateProfile">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">{{ t('email') }}</label>
                                            <input type="email" class="form-control" v-model="userProfile.email" disabled>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">{{ t('phone') }}<span class="required">*</span></label>
                                            <input type="tel" class="form-control" v-model="userProfile.phone" required maxlength="20">
                                            <div class="validation-error" :class="{ show: errors.phone }">{{ errors.phone }}</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">{{ t('firstName') }}<span class="required">*</span></label>
                                            <input type="text" class="form-control" v-model="userProfile.firstName" required maxlength="16">
                                            <div class="validation-error" :class="{ show: errors.firstName }">{{ errors.firstName }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">{{ t('lastName') }}<span class="required">*</span></label>
                                            <input type="text" class="form-control" v-model="userProfile.lastName" required maxlength="16">
                                            <div class="validation-error" :class="{ show: errors.lastName }">{{ errors.lastName }}</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">{{ t('company') }}<span class="required">*</span></label>
                                    <input type="text" class="form-control" v-model="userProfile.company" required maxlength="30">
                                    <div class="validation-error" :class="{ show: errors.company }">{{ errors.company }}</div>
                                </div>

                                <div class="form-text text-muted mb-3">
                                    {{ t('profileNote') }}
                                </div>

                                <button type="submit" class="btn btn-primary" :disabled="saving">
                                    <i class="fas fa-save"></i>
                                    <span v-if="!saving">{{ t('update') }}</span>
                                    <span v-else>{{ t('saving') }}...</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- ‰øÆÊîπÂØÜÁ†Å -->
                <div class="tab-pane fade" id="password" role="tabpanel" v-if="showPasswordTab">
                    <div class="card" data-aos="fade-up">
                        <div class="card-header">
                            <h5><i class="fas fa-lock"></i> {{ t('changePassword') }}</h5>
                        </div>
                        <div class="card-body">
                            <div v-if="passwordMessage.text" :class="'alert alert-' + passwordMessage.type">
                                <i :class="passwordMessage.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'"></i>
                                {{ passwordMessage.text }}
                            </div>

                            <form @submit.prevent="changePassword">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">{{ t('oldPassword') }}<span class="required">*</span></label>
                                            <div class="password-input-container">
                                                <input :type="showOldPassword ? 'text' : 'password'" class="form-control" v-model="passwordForm.oldPassword" required maxlength="12">
                                                <button type="button" class="password-toggle" @click="toggleOldPassword" :aria-label="showOldPassword ? 'Hide password' : 'Show password'">
                                                    <i :class="showOldPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                                </button>
                                            </div>
                                            <div class="validation-error" :class="{ show: passwordErrors.oldPassword }">{{ passwordErrors.oldPassword }}</div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">{{ t('newPassword') }}<span class="required">*</span></label>
                                            <div class="password-input-container">
                                                <input :type="showNewPassword ? 'text' : 'password'" class="form-control" v-model="passwordForm.newPassword" required maxlength="12">
                                                <button type="button" class="password-toggle" @click="toggleNewPassword" :aria-label="showNewPassword ? 'Hide password' : 'Show password'">
                                                    <i :class="showNewPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                                </button>
                                            </div>
                                            <div class="validation-error" :class="{ show: passwordErrors.newPassword }">{{ passwordErrors.newPassword }}</div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">{{ t('confirmPassword') }}<span class="required">*</span></label>
                                            <div class="password-input-container">
                                                <input :type="showConfirmPassword ? 'text' : 'password'" class="form-control" v-model="passwordForm.confirmPassword" required maxlength="12">
                                                <button type="button" class="password-toggle" @click="toggleConfirmPassword" :aria-label="showConfirmPassword ? 'Hide password' : 'Show password'">
                                                    <i :class="showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                                </button>
                                            </div>
                                            <div class="validation-error" :class="{ show: passwordErrors.confirmPassword }">{{ passwordErrors.confirmPassword }}</div>
                                        </div>

                                        <button type="submit" class="btn btn-primary" :disabled="changingPassword">
                                            <i class="fas fa-key"></i>
                                            <span v-if="!changingPassword">{{ t('update') }}</span>
                                            <span v-else>{{ t('updating') }}...</span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Êï∞ÊçÆÂØºÂá∫ÂéÜÂè≤ -->
                <div class="tab-pane fade" id="export" role="tabpanel" v-if="showExportTab">
                    <div class="card" data-aos="fade-up">
                        <div class="card-header">
                            <h5><i class="fas fa-history"></i> {{ t('dataExportHistory') }}</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>{{ t('fileName') }}</th>
                                            <th>{{ t('totalCount') }}</th>
                                            <th>{{ t('exportCount') }}</th>
                                            <th>{{ t('status') }}</th>
                                            <th>{{ t('createDate') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="item in exportData" :key="item.id">
                                            <td><a :href="item.download_link" :download="item.file_name">{{ item.file_name }}</a></td>
                                            <td>{{ item.total_count }}</td>
                                            <td>{{ item.download_count }}</td>
                                            <td class="text-uppercase">{{ item.status }}</td>
                                            <td>{{ item.created_at }}</td>
                                        </tr>
                                        <tr v-if="exportData.length === 0">
                                            <td colspan="5" class="text-center text-muted">{{ t('noData') }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AOS Animation -->
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>

    <!-- ÂÖ®Â±ÄËèúÂçïÁªÑ‰ª∂ -->
    <script src="common/js/inno-global-menu.js"></script>
    <!-- Áî®Êà∑ProfileÁªÑ‰ª∂ -->
    <script src="common/js/user-profile.js"></script>

    <!-- ËÆ§ËØÅÊ£ÄÊü•ËÑöÊú¨ - JWTÈÄöÁî®È™åËØÅ -->
    <script src="common/js/auth-check.js"></script>

    <script>
// Initialize AOS animations
AOS.init({
	duration: 800,
	easing: 'ease-in-out',
	once: true
});

// Vue App
const { createApp } = Vue;

createApp({
	data() {
		return {
			currentLang: localStorage.getItem('inno_lang') || 'zh',
			loading: true,
			saving: false,
			changingPassword: false,
			showPasswordTab: true, // ÊòæÁ§∫‰øÆÊîπÂØÜÁ†ÅÊ†áÁ≠æ
			showExportTab: true, // ÊòæÁ§∫ÂØºÂá∫ÂéÜÂè≤Ê†áÁ≠æ
			userProfile: {
				phone: '',
				email: '',
				firstName: '',
				lastName: '',
				company: '',
				avatar: ''
			},
			passwordForm: {
				oldPassword: '',
				newPassword: '',
				confirmPassword: ''
			},
			showOldPassword: false,
			showNewPassword: false,
			showConfirmPassword: false,
			exportData: [],
			message: {
				text: '',
				type: 'info'
			},
			passwordMessage: {
				text: '',
				type: 'info'
			},
			errors: {},
			passwordErrors: {},
			translations: {
				zh: {
					loading: 'Âä†ËΩΩ‰∏≠',
					editProfile: 'ÁºñËæëËµÑÊñô',
					changePassword: '‰øÆÊîπÂØÜÁ†Å',
					dataExportHistory: 'Êï∞ÊçÆÂØºÂá∫ÂéÜÂè≤',
					personalInformation: '‰∏™‰∫∫‰ø°ÊÅØ',
					phone: 'ÊâãÊú∫Âè∑Á†Å',
					email: 'ÈÇÆÁÆ±Âú∞ÂùÄ',
					firstName: 'ÂêçÂ≠ó',
					lastName: 'ÂßìÊ∞è',
					company: 'ÂÖ¨Âè∏ÂêçÁß∞',
					oldPassword: 'ÊóßÂØÜÁ†Å',
					newPassword: 'Êñ∞ÂØÜÁ†Å',
					confirmPassword: 'Á°ÆËÆ§ÂØÜÁ†Å',
					update: 'Êõ¥Êñ∞',
					saving: '‰øùÂ≠ò‰∏≠',
					updating: 'Êõ¥Êñ∞‰∏≠',
					profileNote: 'ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑ‰∏™‰∫∫‰ø°ÊÅØ‰ª•‰æøÊàë‰ª¨‰∏∫ÊÇ®Êèê‰æõÊõ¥Â•ΩÁöÑÊúçÂä°',
					fileName: 'Êñá‰ª∂Âêç',
					totalCount: 'ÊÄªÊï∞',
					exportCount: 'ÂØºÂá∫Êï∞Èáè',
					status: 'Áä∂ÊÄÅ',
					createDate: 'ÂàõÂª∫Êó•Êúü',
					noData: 'ÊöÇÊó†Êï∞ÊçÆ',
					updateSuccess: 'Êõ¥Êñ∞ÊàêÂäü',
					updateFailed: 'Êõ¥Êñ∞Â§±Ë¥•',
					passwordMismatch: '‰∏§Ê¨°ÂØÜÁ†ÅËæìÂÖ•‰∏ç‰∏ÄËá¥',
					passwordSameAsOld: 'Êñ∞ÂØÜÁ†Å‰∏çËÉΩ‰∏éÊóßÂØÜÁ†ÅÁõ∏Âêå',
					passwordTooShort: 'ÂØÜÁ†ÅÈïøÂ∫¶‰∏çËÉΩÂ∞ë‰∫é6‰Ωç',
					passwordTooShort8: 'ÂØÜÁ†ÅÈïøÂ∫¶‰∏çËÉΩÂ∞ë‰∫é8‰Ωç',
					passwordTooLong: 'ÂØÜÁ†ÅÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá12‰Ωç',
					emailInvalid: 'ÈÇÆÁÆ±Ê†ºÂºè‰∏çÊ≠£Á°Æ',
					fieldRequired: 'Ê≠§Â≠óÊÆµ‰∏∫ÂøÖÂ°´È°π',
					sessionExpired: '‰ºöËØùÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï'
				},
				en: {
					loading: 'Loading',
					editProfile: 'Edit Profile',
					changePassword: 'Change Password',
					dataExportHistory: 'Data Export History',
					personalInformation: 'Personal Information',
					phone: 'Phone',
					email: 'Email',
					firstName: 'First Name',
					lastName: 'Last Name',
					company: 'Company',
					oldPassword: 'Old Password',
					newPassword: 'New Password',
					confirmPassword: 'Confirm Password',
					update: 'Update',
					saving: 'Saving',
					updating: 'Updating',
					profileNote: 'Please fill in your complete personal information so we can serve you better',
					fileName: 'File Name',
					totalCount: 'Total Count',
					exportCount: 'Export Count',
					status: 'Status',
					createDate: 'Create Date',
					noData: 'No Data',
					updateSuccess: 'Update Successful',
					updateFailed: 'Update Failed',
					passwordMismatch: 'Passwords do not match',
					passwordSameAsOld: 'New password cannot be the same as old password',
					passwordTooShort: 'Password must be at least 6 characters',
					passwordTooShort8: 'Password must be at least 8 characters',
					passwordTooLong: 'Password may not be greater than 12 characters',
					emailInvalid: 'Invalid email format',
					fieldRequired: 'This field is required',
					sessionExpired: 'Session expired, please login again'
				}
			}
		}
	},

	async mounted() {
		console.log('Profile page mounting...');

		try {
			// Á≠âÂæÖËÆ§ËØÅÊ£ÄÊü•ÂÆåÊàê
			console.log('Waiting for auth check...');
			await this.waitForAuthCheck();
			console.log('Auth check completed');

			// ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØ
			console.log('Initializing profile...');
			await this.initializeProfile();
			console.log('Profile initialized successfully');

			// Ë∞ÉËØï‰ø°ÊÅØÔºöÊòæÁ§∫Áî®Êà∑Êï∞ÊçÆ
			console.log('User profile data:', this.userProfile);

		} catch (error) {
			console.error('Profile initialization failed:', error);

			// ÊòæÁ§∫ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ
			this.message = {
				text: `Failed to load user profile: ${error.message}`,
				type: 'danger'
			};

			// Â¶ÇÊûúÊòØËÆ§ËØÅÂ§±Ë¥•Ôºå3ÁßíÂêéË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
			if (error.message.includes('Auth check timeout') || error.message.includes('Token validation failed') || error.message.includes('Access Token has expired') || error.message.includes('Authentication failed')) {
				setTimeout(() => {
					window.location.href = '/home_israel.aspx';
				}, 3000);
			}
		} finally {
			this.loading = false;
			console.log('Loading state set to false');
		}
	},

	methods: {
		t(key) {
			return this.translations[this.currentLang][key] || key;
		},

		async waitForAuthCheck() {
			console.log('Starting waitForAuthCheck...');

			// Ê£ÄÊü•ÊòØÂê¶ÊúâÂü∫Êú¨ÁöÑËÆ§ËØÅ‰ø°ÊÅØ
			const apiToken = this.getCookie('api_token');
			const userId = this.getCookie('userId');

			console.log('Available auth data:', {
				hasApiToken: !!apiToken,
				hasUserId: !!userId,
				apiTokenLength: apiToken ? apiToken.length : 0
			});

			return new Promise((resolve, reject) => {
				// È¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶Êúâ‰ªª‰ΩïËÆ§ËØÅÊï∞ÊçÆ
				if (!apiToken && !userId) {
					console.error('No authentication data found');
					reject(new Error('No authentication data found'));
					return;
				}

				// Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÈÄöËøáËÆ§ËØÅ
				if (window.AuthCheck && window.AuthCheck.isAuthenticated()) {
					console.log('Already authenticated');
					resolve();
					return;
				}

				// Á≠âÂæÖËÆ§ËØÅÊ£ÄÊü•ÂÆåÊàêÔºåÊúÄÂ§öÁ≠âÂæÖ10Áßí
				let attempts = 0;
				const maxAttempts = 100; // 10Áßí

				const checkInterval = setInterval(() => {
					attempts++;

					if (window.AuthCheck && window.AuthCheck.isAuthenticated()) {
						console.log('Authentication successful after', attempts, 'attempts');
						clearInterval(checkInterval);
						resolve();
					} else if (attempts >= maxAttempts) {
						console.error('Auth check timeout after', attempts, 'attempts');
						clearInterval(checkInterval);
						reject(new Error('Auth check timeout'));
					} else {
						console.log('Auth check attempt', attempts, 'of', maxAttempts);
					}
				}, 100);
			});
		},

		async toggleLang() {
			this.currentLang = this.currentLang === 'zh' ? 'en' : 'zh';
			localStorage.setItem('inno_lang', this.currentLang);
			window.dispatchEvent(new CustomEvent('inno_lang_change', { detail: this.currentLang }));
		},

		async initializeProfile() {
			// ‰ªéSession/CookieËé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
			await this.loadUserFromSession();
			// Âä†ËΩΩÂØºÂá∫ÂéÜÂè≤ÔºàÂ¶ÇÊûúÊòØÁÆ°ÁêÜÂëòÔºâ
			await this.loadExportHistory();
		},

		async loadUserFromSession() {
			try {
				// Âè™‰ªéSessionStorageËé∑Âèñuser_profile_data
				const sessionUser = sessionStorage.getItem('user_profile_data');
				if (sessionUser) {
					try {
						const userData = JSON.parse(sessionUser);
						console.log('‚úÖ Found user_profile_data in SessionStorage:', userData);

						// Êò†Â∞ÑSessionStorageÊï∞ÊçÆÂà∞Áî®Êà∑ÈÖçÁΩÆÊñá‰ª∂
						const profileData = {
							Email: userData.Email || userData.email || '',
							Phone: userData.Phone || userData.phone || userData.phone_number || '',
							First_name: userData.First_name || userData.first_name || userData.given_name || userData.FirstName || '',
							Last_name: userData.Last_name || userData.last_name || userData.family_name || userData.LastName || '',
							Remark: userData.Remark || userData.company || userData['custom:company'] || userData.Company || '',
							HeadImageURL: userData.HeadImageURL || userData.headImageURL || userData.picture || userData.UserLogo || ''
						};

						this.populateUserProfile(profileData);
						console.log('‚úÖ User data loaded from SessionStorage (user_profile_data):', profileData);
						return;
					} catch (parseError) {
						console.error('‚ùå Failed to parse user_profile_data:', parseError);
						throw new Error('Failed to parse user profile data');
					}
				}

				console.error('‚ùå No user_profile_data found in SessionStorage');
				throw new Error('User data not found in session storage');
			} catch (error) {
				console.error('‚ùå Failed to load user profile:', error);
				throw error;
			}
		},

		populateUserProfile(userData) {
			// Êò†Â∞ÑÁî®Êà∑Êï∞ÊçÆÂà∞VueÁªÑ‰ª∂ÁöÑuserProfileÂØπË±°
			// ÊîØÊåÅÂ§öÁßçÂëΩÂêçÁ∫¶ÂÆö‰ª•ÂÖºÂÆπ‰∏çÂêåÁöÑÊï∞ÊçÆÊ∫ê
			this.userProfile = {
				phone: userData.Phone || userData.phone || userData.phone_number || '',
				email: userData.Email || userData.email || '',
				firstName: userData.First_name || userData.firstName || userData.given_name || userData.first_name || '',
				lastName: userData.Last_name || userData.lastName || userData.family_name || userData.last_name || '',
				company: userData.Remark || userData.company || userData['custom:company'] || '',
				avatar: userData.HeadImageURL || userData.avatar || userData.picture || userData.headImageURL || ''
			};

			console.log('‚úÖ User profile populated:', this.userProfile);
		},

		async loadUserFromAPI(userId) {
			try {
				console.log('üìù Loading user from UserInfo.asmx/Get with userId:', userId);

				// Ë∞ÉÁî® UserInfo.asmx/Get ÊñπÊ≥ï (‰ΩøÁî® GET ÊñπÂºè)
				const response = await axios.get(`/user/UserInfo.asmx/Get?userId=${encodeURIComponent(userId)}`, {
					timeout: 5000
				});

				console.log('‚úÖ UserInfo.asmx response:', response.data);

				if (response.data) {
					// Áõ¥Êé•‰ΩøÁî®ËøîÂõûÁöÑÁî®Êà∑Êï∞ÊçÆ
					const userData = response.data;

					// Êò†Â∞ÑÂà∞Áªü‰∏ÄÊ†ºÂºè
					const profileData = {
						Email: userData.Email || '',
						Phone: userData.Phone || '',
						First_name: userData.First_name || '',
						Last_name: userData.Last_name || '',
						Remark: userData.Remark || '',
						HeadImageURL: userData.HeadImageURL || '',
						Group: userData.Group || '',
						ExpirationDate: userData.ExpirationDate || '',
						Expired: userData.Expired || false
					};

					this.populateUserProfile(profileData);
					console.log('‚úÖ User data loaded from UserInfo.asmx:', profileData);
					return;
				}

				throw new Error('Invalid response from UserInfo.asmx');
			} catch (error) {
				console.error('‚ùå Failed to load user from UserInfo.asmx:', error);

				// ÈôçÁ∫ßÊñπÊ°à1: Â∞ùËØï‰ªé inno_ai_services API
				try {
					const apiDomain = this.getAPIDomain();
					const token = this.getCookie('api_token') || this.getCookie('access_token');

					if (token) {
						console.log('üìù Trying fallback API: /api/User/GetInfo');
						const response = await axios.get(`${apiDomain}/api/User/GetInfo`, {
							headers: {
								'Authorization': `Bearer ${token}`,
								'Content-Type': 'application/json'
							},
							timeout: 5000
						});

						if (response.data && response.data.ReturnCode === 0) {
							const userData = response.data.Data;
							this.populateUserProfile(userData);
							console.log('‚úÖ User data loaded from fallback API:', userData);
							return;
						}
					}
				} catch (fallbackError) {
					console.error('‚ùå Fallback API also failed:', fallbackError);
				}

				// ÈôçÁ∫ßÊñπÊ°à2: ‰ªé JWT token ÊèêÂèñÂü∫Êú¨‰ø°ÊÅØ
				const token = this.getCookie('api_token');
				if (token) {
					const payload = this.parseJWTPayload(token);
					if (payload) {
						console.log('üìù Using JWT token data as last resort');
						const userData = {
							Email: payload.email || payload.username || '',
							Phone: payload.phone_number || '',
							First_name: payload.given_name || payload.first_name || '',
							Last_name: payload.family_name || payload.last_name || '',
							Remark: payload.company || payload['custom:company'] || '',
							HeadImageURL: payload.picture || payload.headImageURL || ''
						};

						this.populateUserProfile(userData);
						console.log('‚úÖ User data loaded from JWT token (last resort):', userData);
						return;
					}
				}

				throw error;
			}
		},

		async loadExportHistory() {
			try {
				const userId = this.getCookie('userId') || this.getCookie('UserID');
				const userGroup = this.getCookie('UserGroup') || '';

				// Âè™ÊúâÁÆ°ÁêÜÂëòÊâçÊòæÁ§∫ÂØºÂá∫ÂéÜÂè≤
				if (userGroup.toLowerCase() !== 'admin') {
					this.showExportTab = false;
					return;
				}

				this.showExportTab = true;
				const apiDomain = this.getAPIDomain();
				const url = `${apiDomain}/api/Company/DownloadList?userId=${userId}&page=1&pageSize=20`;

				const response = await axios.get(url);
				if (response.data && response.data.ReturnCode === 0) {
					this.exportData = response.data.Data.data || [];
				}
			} catch (error) {
				console.error('Failed to load export history:', error);
				this.exportData = [];
			}
		},

		getAPIDomain() {
			// ‰ªéÈÖçÁΩÆËé∑ÂèñAPIÂüüÂêçÔºåÊîØÊåÅÂ§ö‰∏™ÈÖçÁΩÆÊ∫ê
			const apiDomain = window.apiDomain ||
							window.innoApiDomain ||
							'https://ai.innonation.io/inno_ai_services';
			return apiDomain;
		},

		parseJWTPayload(token) {
			try {
				console.log('Parsing JWT token...');
				const parts = token.split('.');
				if (parts.length !== 3) {
					console.error('Invalid JWT format - expected 3 parts, got', parts.length);
					return null;
				}

				const payload = parts[1];
				console.log('JWT payload:', payload);

				// URL-safe Base64 decoding
				let base64 = payload.replace(/-/g, '+').replace(/_/g, '/');

				// Add padding if needed
				while (base64.length % 4) {
					base64 += '=';
				}

				const decoded = atob(base64);
				console.log('Decoded payload:', decoded);

				const parsed = JSON.parse(decoded);
				console.log('Parsed JWT payload:', parsed);

				return parsed;
			} catch (error) {
				console.error('Failed to parse JWT:', error);
				return null;
			}
		},

		validateProfile() {
			this.errors = {};
			let isValid = true;

			// È™åËØÅÁîµËØùÂè∑Á†Å
			if (!this.userProfile.phone || !this.userProfile.phone.trim()) {
				this.errors.phone = this.t('fieldRequired');
				isValid = false;
			}

			// È™åËØÅÂêçÂ≠ó
			if (!this.userProfile.firstName || !this.userProfile.firstName.trim()) {
				this.errors.firstName = this.t('fieldRequired');
				isValid = false;
			}

			// È™åËØÅÂßìÊ∞è
			if (!this.userProfile.lastName || !this.userProfile.lastName.trim()) {
				this.errors.lastName = this.t('fieldRequired');
				isValid = false;
			}

			// È™åËØÅÂÖ¨Âè∏
			if (!this.userProfile.company || !this.userProfile.company.trim()) {
				this.errors.company = this.t('fieldRequired');
				isValid = false;
			}

			return isValid;
		},

		async updateProfile() {
			if (!this.validateProfile()) {
				return;
			}

			this.saving = true;
			this.message = { text: '', type: 'info' };

			try {
				const accessToken = this.getCookie('access_token');
				if (!accessToken) {
					this.message = {
						text: this.t('sessionExpired') || 'Session expired, please login again',
						type: 'danger'
					};
					setTimeout(() => {
						window.location.href = '/home_israel.aspx';
					}, 2000);
					return;
				}

				console.log('üìù Updating user profile via UserInfo.asmx/Update...');

				// Ë∞ÉÁî® UserInfo.asmx/Update ÊñπÊ≥ï
				// ASP.NET ASMX WebService: ÂøÖÈ°ª‰ΩøÁî®POST + application/jsonÊâçËÉΩËøîÂõûJSONÊ†ºÂºè
				// GETËØ∑Ê±ÇËøîÂõûÁöÑÊòØXMLÊ†ºÂºè,Êó†Ê≥ïÁõ¥Êé•Ëß£Êûê
				const response = await axios.post('https://ai.innonation.io/user/UserInfo.asmx/Update', {
					accessToken: accessToken,
					firstName: this.userProfile.firstName.trim(),
					lastName: this.userProfile.lastName.trim(),
					company: this.userProfile.company.trim(),
					phone: this.userProfile.phone.trim(),
					email: this.userProfile.email.trim()
				}, {
					headers: {
						'Content-Type': 'application/json'
					},
					timeout: 10000
				});

				console.log('‚úÖ UserInfo.asmx/Update response:', response.data);

				// ASP.NET ASMXÁöÑJSONÂìçÂ∫îË¢´ÂåÖË£πÂú®.dÂ±ûÊÄß‰∏≠
				// Ê≥®ÊÑèÔºöresponse.data.d Â∑≤ÁªèÊòØËß£ÊûêÂêéÁöÑÂØπË±°Ôºå‰∏çÈúÄË¶ÅÂÜçÊ¨°JSON.parse
				const result = response.data.d || response.data;
				console.log('üìä Parsed result:', result);

				// Ê£ÄÊü•ÊòØÂê¶401ËÆ§ËØÅÂ§±Ë¥•
				if (result && result.ReturnCode === 401) {
					console.log('üîÑ 401 authentication error in response, redirecting to login page...');
					this.message = {
						text: this.t('sessionExpired'),
						type: 'danger'
					};
					setTimeout(() => {
						window.location.href = '/home_israel.aspx';
					}, 2000);
					return;
				}

				if (result && result.ReturnCode === 0) {
					this.message = {
						text: this.t('updateSuccess'),
						type: 'success'
					};

					// Êõ¥Êñ∞SessionStorageÔºåÊ®°ÊãüÂéüÂßãASP.NETÁöÑSession["user"]Ë°å‰∏∫
					// ÈáçË¶ÅÔºö‰øùÂ≠òÊâÄÊúâÂëΩÂêçÂèò‰Ωì‰ª•Á°Æ‰øùÂÖºÂÆπÊÄß
					const updatedUserData = {
						// ÈÇÆÁÆ±
						Email: this.userProfile.email,
						email: this.userProfile.email,
						// ÂêçÂ≠ó (‰ºòÂÖà‰ΩøÁî® First_name Âíå Last_name - Â∏¶‰∏ãÂàíÁ∫øÁöÑPascal Case)
						First_name: this.userProfile.firstName,
						firstName: this.userProfile.firstName,
						first_name: this.userProfile.firstName,
						given_name: this.userProfile.firstName,
						// ÂßìÊ∞è
						Last_name: this.userProfile.lastName,
						lastName: this.userProfile.lastName,
						last_name: this.userProfile.lastName,
						family_name: this.userProfile.lastName,
						// ÂÖ¨Âè∏
						Remark: this.userProfile.company,
						company: this.userProfile.company,
						Company: this.userProfile.company,
						// ÁîµËØù
						Phone: this.userProfile.phone,
						phone: this.userProfile.phone,
						phone_number: this.userProfile.phone,
						// Â§¥ÂÉè
						HeadImageURL: this.userProfile.avatar,
						avatar: this.userProfile.avatar,
						headImageURL: this.userProfile.avatar,
						picture: this.userProfile.avatar
					};

					// ‰øùÂ≠òÂà∞SessionStorageÔºåÂè™‰ΩøÁî®user_profile_dataÈîÆ
					sessionStorage.setItem('user_profile_data', JSON.stringify(updatedUserData));

					console.log('‚úÖ User profile updated and saved to SessionStorage:', updatedUserData);

					// üîÑ ÈáçË¶Å:Á´ãÂç≥Êõ¥Êñ∞ÂΩìÂâçÈ°µÈù¢VueÁªÑ‰ª∂,Á°Æ‰øùÁïåÈù¢ÂÆûÊó∂ÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ
					// VueÁöÑÂìçÂ∫îÂºèÁ≥ªÁªü‰ºöËá™Âä®Êõ¥Êñ∞ÁªëÂÆöÁöÑÁïåÈù¢ÂÖÉÁ¥†(Áî®Êà∑Âêç„ÄÅÈÇÆÁÆ±Á≠â)
					this.userProfile = {
						phone: updatedUserData.Phone,
						email: updatedUserData.Email,
						firstName: updatedUserData.First_name,
						lastName: updatedUserData.Last_name,
						company: updatedUserData.Remark,
						avatar: updatedUserData.HeadImageURL
					};

					console.log('‚úÖ UI data refreshed with updated profile');

					// Êõ¥Êñ∞ÂÖ®Â±ÄËèúÂçïÊòæÁ§∫ÁöÑÁî®Êà∑Âêç(Â¶ÇÊûúÂ≠òÂú®)
					if (window.InnoGlobalMenu && typeof window.InnoGlobalMenu.updateUserInfo === 'function') {
						window.InnoGlobalMenu.updateUserInfo({
							name: `${updatedUserData.First_name} ${updatedUserData.Last_name}`,
							email: updatedUserData.Email,
							company: updatedUserData.Remark
						});
						console.log('‚úÖ Global menu updated with new user info');
					}

					// Â¶ÇÊûúÂéüÂßãASP.NETÈ°µÈù¢ÊúâhiddenÂ≠óÊÆµÔºå‰πüÊõ¥Êñ∞ÈÇ£‰∫õÂ≠óÊÆµ
					const hiddenFields = ['UserID', 'Email', 'FirstName', 'LastName', 'Company'];
					hiddenFields.forEach(fieldName => {
						const field = document.getElementById(fieldName);
						if (field) {
							switch (fieldName) {
								case 'Email':
									field.value = this.userProfile.email;
									break;
								case 'FirstName':
									field.value = this.userProfile.firstName;
									break;
								case 'LastName':
									field.value = this.userProfile.lastName;
									break;
								case 'Company':
									field.value = this.userProfile.company;
									break;
							}
						}
					});

					// Ëß¶ÂèëÂÖ®Â±ÄÁî®Êà∑Êï∞ÊçÆÊõ¥Êñ∞‰∫ã‰ª∂ÔºàÂ¶ÇÊûúÊúâÂÖ∂‰ªñÁªÑ‰ª∂ÈúÄË¶ÅÁõëÂê¨Ôºâ
					window.dispatchEvent(new CustomEvent('user_profile_updated', {
						detail: updatedUserData
					}));
				} else {
					this.message = {
						text: result?.Message || response.data?.Message || this.t('updateFailed'),
						type: 'danger'
					};
				}
			} catch (error) {
				console.error('‚ùå Failed to update profile:', error);

				// Â§ÑÁêÜÁâπÊÆäÈîôËØØ‰ø°ÊÅØ
				let errorMessage = this.t('updateFailed');

				// Ê£ÄÊü•ASMXÂìçÂ∫îÁªìÊûÑ (response.data.d.ReturnCode)
				let asmxResult = null;
				if (error.response?.data?.d && typeof error.response.data.d === 'object') {
					asmxResult = error.response.data.d;
				} else if (error.response?.data && typeof error.response.data === 'object') {
					asmxResult = error.response.data;
				}

				// ËØ¶ÁªÜÁöÑ401Ê£ÄÊµãÈÄªËæë
				const isAuthError =
					// HTTP 401Áä∂ÊÄÅÁ†Å
					error.response?.status === 401 ||
					// ASMX ReturnCode 401
					(asmxResult && asmxResult.ReturnCode === 401) ||
					// ÂêÑÁßçËÆ§ËØÅÈîôËØØÊ∂àÊÅØ
					error.message?.includes('Authentication failed') ||
					error.message?.includes('Access Token has expired') ||
					error.message?.includes('Token validation failed') ||
					error.message?.includes('Auth check timeout') ||
					// ASMXÂìçÂ∫î‰∏≠ÁöÑÈîôËØØÊ∂àÊÅØ
					asmxResult?.Message?.includes('Authentication failed') ||
					asmxResult?.Message?.includes('Access Token has expired') ||
					asmxResult?.Error?.includes('Authentication failed') ||
					asmxResult?.Error?.includes('Access Token has expired') ||
					// HTTPÂìçÂ∫î‰∏≠ÁöÑÈîôËØØÊ∂àÊÅØ
					error.response?.data?.Message?.includes('Authentication failed') ||
					error.response?.data?.Message?.includes('Access Token has expired');

				if (isAuthError) {
					errorMessage = this.t('sessionExpired');
					console.log('üîÑ 401 authentication error detected, redirecting to login page...');
					setTimeout(() => {
						window.location.href = '/home_israel.aspx';
					}, 2000);
				} else if (error.response?.data?.Message) {
					errorMessage = error.response.data.Message;
				} else if (asmxResult?.Message) {
					errorMessage = asmxResult.Message;
				} else if (error.message) {
					errorMessage = error.message;
				}

				this.message = {
					text: errorMessage,
					type: 'danger'
				};
			} finally {
				this.saving = false;
				// 5ÁßíÂêéÊ∏ÖÈô§Ê∂àÊÅØ
				setTimeout(() => {
					this.message = { text: '', type: 'info' };
				}, 5000);
			}
		},

		validatePassword() {
			this.passwordErrors = {};
			let isValid = true;

			// È™åËØÅÊóßÂØÜÁ†Å
			if (!this.passwordForm.oldPassword) {
				this.passwordErrors.oldPassword = this.t('fieldRequired');
				isValid = false;
			} else if (this.passwordForm.oldPassword.length < 8) {
				this.passwordErrors.oldPassword = this.t('passwordTooShort8');
				isValid = false;
			} else if (this.passwordForm.oldPassword.length > 12) {
				this.passwordErrors.oldPassword = this.t('passwordTooLong');
				isValid = false;
			}

			// È™åËØÅÊñ∞ÂØÜÁ†Å
			if (!this.passwordForm.newPassword) {
				this.passwordErrors.newPassword = this.t('fieldRequired');
				isValid = false;
			} else if (this.passwordForm.newPassword.length < 8) {
				this.passwordErrors.newPassword = this.t('passwordTooShort8');
				isValid = false;
			} else if (this.passwordForm.newPassword.length > 12) {
				this.passwordErrors.newPassword = this.t('passwordTooLong');
				isValid = false;
			} else if (this.passwordForm.oldPassword && this.passwordForm.newPassword === this.passwordForm.oldPassword) {
				this.passwordErrors.newPassword = this.t('passwordSameAsOld');
				isValid = false;
			}

			// È™åËØÅÁ°ÆËÆ§ÂØÜÁ†Å
			if (!this.passwordForm.confirmPassword) {
				this.passwordErrors.confirmPassword = this.t('fieldRequired');
				isValid = false;
			} else if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
				this.passwordErrors.confirmPassword = this.t('passwordMismatch');
				isValid = false;
			}

			return isValid;
		},

		async changePassword() {
			if (!this.validatePassword()) {
				return;
			}

			this.changingPassword = true;
			this.passwordMessage = { text: '', type: 'info' };

			try {
				const accessToken = this.getCookie('access_token');
				if (!accessToken) {
					this.passwordMessage = {
						text: this.t('sessionExpired') || 'Session expired, please login again',
						type: 'danger'
					};
					setTimeout(() => {
						window.location.href = '/home_israel.aspx';
					}, 2000);
					return;
				}

				console.log('üìù Changing password via UserInfo.asmx/ChangePassword...');

				// Call UserInfo.asmx/ChangePassword method
				const response = await axios.post('https://ai.innonation.io/user/UserInfo.asmx/ChangePassword', {
					accessToken: accessToken,
					oldPassword: this.passwordForm.oldPassword,
					newPassword: this.passwordForm.newPassword,
					phone: this.userProfile.phone || ''
				}, {
					headers: {
						'Content-Type': 'application/json'
					},
					timeout: 10000
				});

				console.log('‚úÖ UserInfo.asmx/ChangePassword response:', response.data);

				// ASP.NET ASMX wraps JSON response in .d property
				const result = response.data.d || response.data;
				console.log('üìä Parsed result:', result);

				// Check for 401 authentication failure
				if (result && result.ReturnCode === 401) {
					console.log('üîÑ 401 authentication error in response, redirecting to login page...');
					this.passwordMessage = {
						text: this.t('sessionExpired'),
						type: 'danger'
					};
					setTimeout(() => {
						window.location.href = '/home_israel.aspx';
					}, 2000);
					return;
				}

				if (result && result.ReturnCode === 0) {
					this.passwordMessage = {
						text: this.t('updateSuccess'),
						type: 'success'
					};
					// Ê∏ÖÁ©∫Ë°®Âçï
					this.passwordForm = {
						oldPassword: '',
						newPassword: '',
						confirmPassword: ''
					};
				} else {
					this.passwordMessage = {
						text: result?.Message || response.data?.Message || this.t('updateFailed'),
						type: 'danger'
					};
				}
			} catch (error) {
				console.error('Failed to change password:', error);

				// Â§ÑÁêÜÁâπÊÆäÈîôËØØ‰ø°ÊÅØ
				let errorMessage = this.t('updateFailed');

				// Ê£ÄÊü•ASMXÂìçÂ∫îÁªìÊûÑ (response.data.d.ReturnCode)
				let asmxResult = null;
				if (error.response?.data?.d && typeof error.response.data.d === 'object') {
					asmxResult = error.response.data.d;
				} else if (error.response?.data && typeof error.response.data === 'object') {
					asmxResult = error.response.data;
				}

				// ËØ¶ÁªÜÁöÑ401Ê£ÄÊµãÈÄªËæë
				const isAuthError =
					// HTTP 401Áä∂ÊÄÅÁ†Å
					error.response?.status === 401 ||
					// ASMX ReturnCode 401
					(asmxResult && asmxResult.ReturnCode === 401) ||
					// ÂêÑÁßçËÆ§ËØÅÈîôËØØÊ∂àÊÅØ
					error.message?.includes('Authentication failed') ||
					error.message?.includes('Access Token has expired') ||
					error.message?.includes('Token validation failed') ||
					error.message?.includes('Auth check timeout') ||
					// ASMXÂìçÂ∫î‰∏≠ÁöÑÈîôËØØÊ∂àÊÅØ
					asmxResult?.Message?.includes('Authentication failed') ||
					asmxResult?.Message?.includes('Access Token has expired') ||
					asmxResult?.Error?.includes('Authentication failed') ||
					asmxResult?.Error?.includes('Access Token has expired') ||
					// HTTPÂìçÂ∫î‰∏≠ÁöÑÈîôËØØÊ∂àÊÅØ
					error.response?.data?.Message?.includes('Authentication failed') ||
					error.response?.data?.Message?.includes('Access Token has expired');

				if (isAuthError) {
					errorMessage = this.t('sessionExpired');
					console.log('üîÑ 401 authentication error detected, redirecting to login page...');
					setTimeout(() => {
						window.location.href = '/home_israel.aspx';
					}, 2000);
				} else if (error.response?.data?.Message) {
					errorMessage = error.response.data.Message;
				} else if (asmxResult?.Message) {
					errorMessage = asmxResult.Message;
				} else if (error.message) {
					errorMessage = error.message;
				}

				this.passwordMessage = {
					text: errorMessage,
					type: 'danger'
				};
			} finally {
				this.changingPassword = false;
				// 5ÁßíÂêéÊ∏ÖÈô§Ê∂àÊÅØ
				setTimeout(() => {
					this.passwordMessage = { text: '', type: 'info' };
				}, 5000);
			}
		},

		getCookie(name) {
			const value = `; ${document.cookie}`;
			const parts = value.split(`; ${name}=`);
			if (parts.length === 2) return parts.pop().split(';').shift();
			return null;
		},

		toggleOldPassword() {
			this.showOldPassword = !this.showOldPassword;
		},

		toggleNewPassword() {
			this.showNewPassword = !this.showNewPassword;
		},

		toggleConfirmPassword() {
			this.showConfirmPassword = !this.showConfirmPassword;
		}
	}
}).mount('#app');
    </script>
</body>
</html>
